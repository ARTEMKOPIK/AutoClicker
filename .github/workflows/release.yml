name: Build & Release APK

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4

    - name: Generate Gradle Wrapper
      run: gradle wrapper

    - name: Extract version from tag
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

    - name: Update version in build.gradle.kts
      run: |
        sed -i "s/versionName = \".*\"/versionName = \"${{ steps.version.outputs.VERSION }}\"/" app/build.gradle.kts
        VERSION_CODE=$(echo "${{ steps.version.outputs.VERSION }}" | sed 's/\.//g')
        sed -i "s/versionCode = [0-9]*/versionCode = $VERSION_CODE/" app/build.gradle.kts

    - name: Build Release APK
      env:
        CRASH_BOT_TOKEN: ${{ secrets.CRASH_BOT_TOKEN }}
        CRASH_CHAT_ID: ${{ secrets.CRASH_CHAT_ID }}
      run: ./gradlew assembleRelease

    - name: Sign APK
      uses: r0adkll/sign-android-release@v1
      id: sign_app
      with:
        releaseDirectory: app/build/outputs/apk/release
        signingKeyBase64: ${{ secrets.SIGNING_KEY }}
        alias: ${{ secrets.KEY_ALIAS }}
        keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
        keyPassword: ${{ secrets.KEY_PASSWORD }}
      env:
        BUILD_TOOLS_VERSION: "34.0.0"

    - name: Rename APK
      run: |
        mv ${{ steps.sign_app.outputs.signedReleaseFile }} app/build/outputs/apk/release/AutoClicker-${{ steps.version.outputs.VERSION }}.apk

    - name: Extract changelog
      id: changelog
      run: |
        if [ -f "CHANGELOG.md" ]; then
          CHANGELOG=$(sed -n "/## \[${{ steps.version.outputs.VERSION }}\]/,/## \[/p" CHANGELOG.md | sed '1d;$d')
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="Обновление до версии ${{ steps.version.outputs.VERSION }}"
          fi
        else
          CHANGELOG="Обновление до версии ${{ steps.version.outputs.VERSION }}"
        fi
        echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        name: "AutoClicker v${{ steps.version.outputs.VERSION }}"
        body: ${{ steps.changelog.outputs.CHANGELOG }}
        files: app/build/outputs/apk/release/AutoClicker-${{ steps.version.outputs.VERSION }}.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Commit version update
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add app/build.gradle.kts
        git commit -m "chore: bump version to ${{ steps.version.outputs.VERSION }}" || echo "No changes to commit"
        git push origin HEAD:main || echo "Push failed, may need to pull first"
