name: Auto Release

on:
  push:
    branches: [main]
    paths-ignore:
      - '*.md'
      - '.github/**'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4

    - name: Generate Gradle Wrapper
      run: gradle wrapper

    - name: Get current version and increment
      id: version
      run: |
        # Получаем текущую версию из build.gradle.kts
        CURRENT=$(grep 'versionName = ' app/build.gradle.kts | sed 's/.*"\(.*\)".*/\1/')
        echo "Current version: $CURRENT"
        
        # Разбиваем на части
        IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
        
        # Увеличиваем patch версию
        PATCH=$((PATCH + 1))
        NEW_VERSION="$MAJOR.$MINOR.$PATCH"
        VERSION_CODE="${MAJOR}${MINOR}${PATCH}"
        
        echo "New version: $NEW_VERSION"
        echo "VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_OUTPUT

    - name: Update version in build.gradle.kts
      run: |
        sed -i "s/versionName = \".*\"/versionName = \"${{ steps.version.outputs.VERSION }}\"/" app/build.gradle.kts
        sed -i "s/versionCode = [0-9]*/versionCode = ${{ steps.version.outputs.VERSION_CODE }}/" app/build.gradle.kts

    - name: Build Release APK
      env:
        CRASH_BOT_TOKEN: ${{ secrets.CRASH_BOT_TOKEN }}
        CRASH_CHAT_ID: ${{ secrets.CRASH_CHAT_ID }}
      run: ./gradlew assembleRelease

    - name: Sign APK
      uses: r0adkll/sign-android-release@v1
      id: sign_app
      with:
        releaseDirectory: app/build/outputs/apk/release
        signingKeyBase64: ${{ secrets.SIGNING_KEY }}
        alias: ${{ secrets.KEY_ALIAS }}
        keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
        keyPassword: ${{ secrets.KEY_PASSWORD }}
      env:
        BUILD_TOOLS_VERSION: "34.0.0"

    - name: Rename APK
      run: |
        mv ${{ steps.sign_app.outputs.signedReleaseFile }} app/build/outputs/apk/release/AutoClicker-${{ steps.version.outputs.VERSION }}.apk

    - name: Get commit message for changelog
      id: commit
      run: |
        MSG=$(git log -1 --pretty=%B)
        echo "MESSAGE<<EOF" >> $GITHUB_OUTPUT
        echo "$MSG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.version.outputs.VERSION }}
        name: "AutoClicker v${{ steps.version.outputs.VERSION }}"
        body: |
          ### Изменения
          ${{ steps.commit.outputs.MESSAGE }}
        files: app/build/outputs/apk/release/AutoClicker-${{ steps.version.outputs.VERSION }}.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Commit version update
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add app/build.gradle.kts
        git diff --staged --quiet || git commit -m "chore: bump version to ${{ steps.version.outputs.VERSION }} [skip ci]"
        git push
